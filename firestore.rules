rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================
    // üîê HELPER FUNCTIONS
    // ========================
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Fetch user profile to check role
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user has 'admin' or 'super_admin' role
    function isAdmin() {
      return isAuthenticated() && 
        (getUserData().role == 'admin' || getUserData().role == 'super_admin');
    }

    // Check if user is an instructor/teacher
    function isInstructor() {
      return isAuthenticated() && 
        (getUserData().role == 'teacher' || isAdmin());
    }

    // ========================
    // üìÇ COLLECTION RULES
    // ========================

    // 1Ô∏è‚É£ USERS COLLECTION
    match /users/{userId} {
      allow read: if true; // Public profiles allowed
      allow create: if isOwner(userId); // Sign up
      allow update: if isOwner(userId) || isAdmin(); // Profile edit
      allow delete: if isAdmin(); // Only admin can ban/delete
    }

    // 2Ô∏è‚É£ COURSES & LESSONS
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin() || isInstructor();
    }

    // 3Ô∏è‚É£ ENROLLMENTS (Course Access)
    match /enrollments/{enrollmentId} {
      // User sees their own, Admins/Instructors see all
      allow read: if isOwner(resource.data.userId) || isAdmin() || isInstructor();
      // User creates enrollment (free courses)
      allow create: if isOwner(request.resource.data.userId) || isAdmin();
      // Progress updates
      allow update: if isOwner(resource.data.userId) || isAdmin();
    }

    // 4Ô∏è‚É£ INTERACTIVE SOUND SYSTEM (New)
    match /sound_assets/{soundId} {
      allow read: if true; // All users need to download sounds
      allow write: if isAdmin(); // Only admin configures sounds
    }

    // 5Ô∏è‚É£ EXAMS & RESULTS
    match /exams/{examId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isInstructor();
    }

    match /results/{resultId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId); // Submit exam
      allow update: if isAdmin(); // Results are immutable for students
    }

    // 6Ô∏è‚É£ PAYMENTS & TRANSACTIONS
    match /payment_methods/{methodId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /payments/{paymentId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isAdmin(); // Only admin approves/rejects
    }

    // 7Ô∏è‚É£ CAMPAIGNS & COUPONS
    match /campaigns/{campaignId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /coupons/{couponId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 8Ô∏è‚É£ NEWS & BLOG
    match /news/{newsId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 9Ô∏è‚É£ SOCIAL: COMMENTS & REVIEWS
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // üîü WEBSITE SETTINGS (Slider, Popups, Config)
    match /site_settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /slides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /popups/{popupId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 1Ô∏è‚É£1Ô∏è‚É£ MEDIA FILES (Storage Meta)
    match /media_files/{fileId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow delete: if isOwner(resource.data.uploadedBy) || isAdmin();
    }

    // 1Ô∏è‚É£2Ô∏è‚É£ SUPPORT & CONTACT
    match /tickets/{ticketId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isAdmin() || isOwner(resource.data.userId);
    }

    match /messages/{messageId} {
      allow create: if true; // Public contact form
      allow read, update, delete: if isAdmin();
    }
    
    match /faqs/{faqId} {
      allow read: if true;
      allow write: if isAdmin();
      // Allow increasing helpful count (simplified check)
      allow update: if true;
    }

    // 1Ô∏è‚É£3Ô∏è‚É£ SYSTEM LOGS
    match /user_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
    }
  }
}